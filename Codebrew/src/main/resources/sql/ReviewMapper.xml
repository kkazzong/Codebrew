<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
		PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
		"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
		
<mapper namespace="ReviewMapper">

<!-- review 관련하여 필요한 review Table 조회 : review(VO)는 user domain 객체와 festival domain 객체를 가진다. -->

	<!-- TTL : 13 in the class , 11 Columns in the DB -->
	<resultMap id="reviewSelectMap" type="review">
		<result property="reviewNo" column="review_no" jdbcType="NUMERIC"/>
		<result property="writerId" column="user_id" jdbcType="VARCHAR"/>
		<result property="festivalNo" column="festival_no" jdbcType="NUMERIC"/>
		<result property="festivalName" column="festival_name" jdbcType="VARCHAR"/>
		<result property="checkCode" column="check_code" jdbcType="VARCHAR"/>
		<result property="reviewTitle" column="review_title" jdbcType="VARCHAR"/>
		<result property="goodCount" column="good_count" jdbcType="NUMERIC"/>
		<result property="reviewFestivalRating" column="review_festival_rating" jdbcType="NUMERIC"/>
		<result property="reviewVideo" column="review_video" jdbcType="VARCHAR"/>
		<result property="reviewDetail" column="review_detail" jdbcType="VARCHAR"/>
		<result property="reviewRegDate" column="review_reg_date" jdbcType="DATE"/>
		<!-- <result property="deleteFlag" column="delete_flag" jdbcType="VARCHAR"/>	 -->
		
		<!-- TTL : 5 Fields in the class , 5 Columns in the DB -->
		<collection property="reply" ofType="reply">
			<result property="replyNo" column="reply_no" jdbcType="NUMERIC"/>
			<result property="userId" column="user_id" jdbcType="VARCHAR"/>
			<result property="reviewNo" column="review_no" jdbcType="NUMERIC"/>
			<result property="replyDetail" column="reply_detail" jdbcType="VARCHAR"/>
			<result property="replyRegDate" column="reply_reg_date" jdbcType="DATE"/>
		</collection>
		<!-- TTL : 3 Fields in the class , 3 Columns in the DB -->
		<collection property="reviewImage" ofType="image">
			<result property="imageNo" column="image_no" jdbcType="NUMERIC"/>
			<result property="reviewNo" column="review_no" jdbcType="NUMERIC"/>
			<result property="reviewImage" column="review_image" jdbcType="VARCHAR"/>
		</collection>
		<!-- TTL : 3 Fields in the class , 3 Columns in the DB -->
		<collection property="reviewHashtag" ofType="hashtag">
			<result property="hashtagNo" column="hashtag_no" jdbcType="NUMERIC"/>
			<result property="reviewNo" column="review_no" jdbcType="NUMERIC"/>
			<result property="hashtagDetail" column="hashtag_detail" jdbcType="VARCHAR"/>
		</collection>
	</resultMap>
	
	
	<resultMap id="replySelectMap" type="reply">
		<result property="replyNo" column="reply_no" jdbcType="NUMERIC"/>
		<result property="userId" column="user_id" jdbcType="VARCHAR"/>
		<result property="reviewNo" column="review_no" jdbcType="NUMERIC"/>
		<result property="replyDetail" column="reply_detail" jdbcType="VARCHAR"/>
		<result property="replyRegDate" column="reply_reg_date" jdbcType="DATE"/>
	</resultMap>
	
	<resultMap id="imageSelectMap" type="image">
		<result property="imageNo" column="image_no" jdbcType="VARCHAR"/>
		<result property="reviewNo" column="review_no" jdbcType="NUMERIC"/>
		<result property="reviewImage" column="review_image" jdbcType="VARCHAR"/>
	</resultMap>
	
	<resultMap id="hashtagSelectMap" type="hashtag">
		<result property="hashtagNo" column="hashtag_no" jdbcType="NUMERIC"/>
		<result property="reviewNo" column="review_no" jdbcType="NUMERIC"/>
		<result property="hashtagDetail" column="hashtag_detail" jdbcType="VARCHAR"/>
	</resultMap>
	
	<resultMap id="goodSelectMap" type="good">
		<result property="goodNo" column="good_no" jdbcType="NUMERIC"/>
		<result property="reviewNo" column="review_no" jdbcType="NUMERIC"/>
		<result property="userId" column="user_id" jdbcType="VARCHAR"/>
	</resultMap>
	
	
	<insert id="addReview" parameterType="review" useGeneratedKeys="true" keyProperty="reviewNo" keyColumn="review_no">
		INSERT 
			INTO review (
						review_no, 
						user_id, 
						festival_no, 
						check_code, 
						review_title, 
						good_count, 
						review_festival_rating, 
						review_video, 
						review_detail, 
						review_reg_date, 
						delete_flag
						)
			VALUES 	(
					seq_review_review_no.nextval, 
					#{writerId:VARCHAR}, 
					#{festivalNo:VARCHAR}, 
					'1', 
					#{reviewTitle:VARCHAR}, 
					0, 
					#{reviewFestivalRating:NUMERIC}, 
					#{reviewVideo:VARCHAR}, 
					#{reviewDetail:VARCHAR}, 
					SYSDATE, 
					'1'
					)
	</insert>
	
	<insert id="uploadReviewImage" parameterType="map" useGeneratedKeys="true" keyProperty="imageNo" keyColumn="image_no">
		INSERT 
			INTO image 	(
						image_no, 
						review_no, 
						review_image
						)
		VALUES( seq_image_image_no.nextval, #{reviewNo}, #{reviewImage.reviewImage})
	</insert>
	
	<insert id="uploadReviewHashtag" parameterType="map" useGeneratedKeys="true" keyProperty="hashtagNo" keyColumn="hashtag_no">
		INSERT 
			INTO hashtag 	(
						hashtag_no, 
						review_no, 
						hashtag_detail
						)
		VALUES( seq_hashtag_hashtag_no.nextval, #{reviewNo}, #{reviewHashtag.hashtagDetail})
	</insert>
	
	
	<update id="passCheckCode" parameterType="review">
		UPDATE review SET
			<if test="checkCode=='1'">
				checkCode = '2'			
			</if>
			<if test="checkCode=='11'">
				checkCode='22'
			</if>
		WHERE review_no=#{reviewNo}
	</update>
	
	
	<update id="failCheckCode" parameterType="review">
		UPDATE review SET
			<if test="checkCode=='1'">
				checkCode = '4'			
			</if>
			<if test="checkCode=='11'">
				checkCode='44'
			</if>
		WHERE review_no=#{reviewNo}
	</update>
	
	<!-- SELECT rv.review_no, rv.user_id, rv.festival_no, f.festival_name, rv.check_code, rv.review_title, rv.good_count,
	rv.review_festival_rating, rv.review_video, rv.review_detail, rv.review_reg_date, rv.delete_flag, 
	rp.reply_no, rp.user_id, rp.reply_detail, rp.reply_reg_date, i.review_image
	FROM review rv, festival f,
	(SELECT image_no, review_no, review_image FROM image WHERE review_no=10018) i, 
	(SELECT good_no, review_no, user_id FROM good WHERE review_no=10018) g, 
	(SELECT hashtag_no, review_no, hashtag_detail FROM hashtag WHERE review_no=10018) h, 
	(SELECT reply_no, review_no, user_id, reply_detail, reply_reg_date FROM reply WHERE review_no=10018) rp 
	WHERE rv.review_no=rp.review_no(+) AND rv.review_no=i.review_no(+) AND rv.review_no=g.review_no(+) 
	AND rv.review_no=h.review_no(+) AND rv.review_no=10018 AND rv.festival_no = f.festival_no ; -->
	
	<!-- 
	<select id="getGoodCount" parameterType="int" resultMap="int">
		SELECT 
			COUNT(*) 
		FROM good 
		WHERE review_no = #{reviewNo}
	</select>
	 -->
	
	<select id="getReview" parameterType="int" resultMap="reviewSelectMap">
		SELECT
			rv.review_no, 
			rv.user_id, 
			rv.festival_no,
			f.festival_name AS festival_name, 
			rv.check_code, 
			rv.review_title, 
			rv.good_count, 
			rv.review_festival_rating, 
			rv.review_video, 
			rv.review_detail, 
			rv.review_reg_date, 
			rv.delete_flag, 
			rp.reply_no, 
			rp.user_id, 
			rp.reply_detail, 
			rp.reply_reg_date,
			i.review_image, 
			h.hashtag_detail 
		FROM review rv, festival f,
			(SELECT image_no, review_no, review_image FROM image WHERE review_no=#{reviewNo}) i, 
			(SELECT hashtag_no, review_no, hashtag_detail FROM hashtag WHERE review_no=#{reviewNo}) h, 
			(SELECT good_no, review_no, user_id FROM good WHERE review_no=#{reviewNo}) g, 
			(SELECT reply_no, review_no, user_id, reply_detail, reply_reg_date FROM reply WHERE review_no=#{reviewNo}) rp
		WHERE rv.review_no=rp.review_no(+) 
		AND rv.review_no=i.review_no(+)
		AND rv.review_no=g.review_no(+) 
		AND rv.review_no=h.review_no(+) 
		AND rv.festival_no = f.festival_no
		AND rv.review_no=#{reviewNo}
	</select>
	
	
	<select id="getReviewImage" parameterType="int" resultMap="imageSelectMap">
		SELECT
			image_no, 
			review_no, 
			review_image
		FROM image 
		WHERE review_no=#{reviewNo}
	</select>
	
	
	<select id="getReviewHashtag" parameterType="int" resultMap="hashtagSelectMap">
		SELECT
			hashtag_no, 
			review_no, 
			hashtag_detail 
		FROM hashtag
		WHERE review_no=#{reviewNo}
	</select>
	
	
	<update id="deleteReview" parameterType="int">
		UPDATE review SET
			delete_flag = '4'
		WHERE review_no = #{reviewNo}
	</update>
	
	
	<insert id="addGood" parameterType="user">
		INSERT 
			INTO good 	(
						good_no, 
						review_no, 
						user_id
						) 
			VALUES 	(
					seq_good_good_no.nextval, 
					#{reviewNo}, 
					#{userId}
					)
	</insert>
	
	
	<delete id="deleteGood" parameterType="int">
		DELETE from good
		WHERE good_no = #{goodNo}
	</delete>
	
	<select id="getReviewList" parameterType="search" resultMap="reviewSelectMap">
		SELECT *
	  	FROM ( SELECT inner_table.*, ROWNUM AS row_seq
	  		FROM ( 	SELECT 	review_no, 
	  						user_id, 
	  						festival_no, 
	  						review_title 
					FROM review
						<if test="searchCondition != null">
							<where>
								<if test="searchCondition == 0 and searchKeyword !='' ">
					 				review_title like '%${searchKeyword}%' 
								</if>
								<if test="searchCondition == 1 and searchKeyword !='' ">
					 				festival_no like '%${searchKeyword}%' 
								</if>
							</where>
						</if>
					ORDER BY review_no ) inner_table
			WHERE ROWNUM &lt;= #{endRowNum} )
		WHERE row_seq BETWEEN #{startRowNum} AND #{endRowNum} 
	</select>
	
	
	<select id="getMyReviewList" parameterType="search" resultMap="reviewSelectMap">
		SELECT *
	  	FROM ( SELECT inner_table.*, ROWNUM AS row_seq
	  		FROM ( 	SELECT 	review_no, 
	  						user_id, 
	  						festival_no, 
	  						review_title 
					FROM review
						<if test="searchCondition != null">
							<where>
								<if test="searchCondition == 0 and searchKeyword !='' ">
					 				review_title like '%${searchKeyword}%' 
								</if>
								<if test="searchCondition == 1 and searchKeyword !='' ">
					 				festival_no like '%${searchKeyword}%' 
								</if>
							</where>
						</if>
					ORDER BY review_no ) inner_table
			WHERE ROWNUM &lt;= #{endRowNum} )
		WHERE row_seq BETWEEN #{startRowNum} AND #{endRowNum} 
	</select>
	
</mapper>